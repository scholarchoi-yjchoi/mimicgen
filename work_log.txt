# Isaac Lab MimicGen Data Generation 문제 해결 작업 로그

## 작업 일시
2026-02-03 (이전 세션에서 시작, 본 세션에서 완료)

## 문제 상황
- Isaac Lab MimicGen Blueprint 노트북의 "Data Generation" 셀이 블로킹됨
- "[Trial 1/5] 시작..." 메시지 이후 무한 대기 상태
- Jupyter 노트북과 Isaac Sim의 asyncio 이벤트 루프 충돌이 원인

## 이전 시도 (v6~v8)
- v6: `loop.run_until_complete()` → 블로킹
- v7: `ThreadPoolExecutor` 사용 → 블로킹
- v8: `simulation_app.update()` 폴링 + 스레드 → 블로킹

## 본 세션 작업 내용

### 1. 근본 원인 분석
- Jupyter와 Isaac Sim(Kit)이 각각 자체 asyncio 이벤트 루프를 사용
- `asyncio.get_event_loop()`가 Kit의 루프가 아닌 새 루프를 생성
- Kit의 async_engine에서 `assert events._get_running_loop() is self` 검증 실패

### 2. Standalone 스크립트 접근 (v9 계획)
- Jupyter 대신 독립 Python 스크립트로 데이터 생성 실행 결정
- 새 파일 생성: `notebook/generate_data_standalone.py`

### 3. 시도한 버전들

#### v1 (초기): 기본 asyncio 루프
- `asyncio.new_event_loop()` + `run_until_complete()` 사용
- 결과: `__aenter__` 오류 (asyncio_lock=None 문제)

#### v2: 더미 락 클래스 추가
- `DummyAsyncLock` 클래스 생성하여 `async with` 지원
- 결과: Kit async_engine의 AssertionError 지속

#### v3: 공식 Isaac Lab API 사용
- `setup_async_generation()`, `env_loop()` 함수 사용
- 결과: 여전히 AssertionError (새 루프와 Kit 루프 충돌)

#### v4: Kit 이벤트 루프 직접 사용 시도
- `omni.kit.async_engine.async_engine._loop` 접근 시도
- 결과: AttributeError (API가 다름)

#### v5 (성공): nest_asyncio + 공식 API
- `nest_asyncio.apply()` 추가 (노트북과 동일한 환경)
- 공식 API (`setup_async_generation()`, `env_loop()`) 사용
- Python `-u` 플래그로 unbuffered 출력
- 결과: **성공!**

### 4. 최종 해결책

#### 핵심 코드 (generate_data_standalone.py)
```python
# nest_asyncio 적용 (노트북과 동일하게)
import nest_asyncio
nest_asyncio.apply()

# ... AppLauncher 초기화 ...

# 공식 API 사용
from isaaclab_mimic.datagen.generation import setup_env_config, env_loop, setup_async_generation

async_gen = setup_async_generation(
    env=env,
    num_envs=args_cli.num_envs,
    input_file=args_cli.input_file,
    success_term=success_term,
    pause_subtask=args_cli.pause_subtask
)

env_loop(
    env=env,
    env_action_queue=async_gen['action_queue'],
    shared_datagen_info_pool=async_gen['info_pool'],
    asyncio_event_loop=async_gen['event_loop']
)
```

#### 실행 명령
```bash
docker exec synthetic-manipulation-motion-generation-isaac-lab-1 \
    /workspace/isaaclab/_isaac_sim/python.sh -u \
    /workspace/isaaclab/generate_data_standalone.py
```

### 5. 수정된 파일 목록

| 파일 | 작업 |
|------|------|
| `notebook/generate_data_standalone.py` | 새로 생성 (v5 - nest_asyncio + 공식 API) |
| `docker-compose.yml` | standalone 스크립트 마운트 추가 |
| `launch.sh` | MODE 환경변수 및 -u 플래그 지원 추가 |

### 6. 실행 결과
```
[Standalone] Data Generation 시작 (v5 - nest_asyncio)
[1/5] AppLauncher 시작 중...
      -> AppLauncher 완료
[2/5] 모듈 임포트 중...
      -> 모듈 임포트 완료
[3/5] 환경 설정 중...
      -> 환경 설정 완료
[4/5] 비동기 생성 설정 중...
Loaded 10 to datagen info pool
      -> 비동기 생성 설정 완료
[5/5] 데이터 생성 시작!
목표: 1개 성공

**************************************************
have 1 successes out of 1 trials so far
have 0 failures out of 1 trials so far
**************************************************
Reached 1 successes/attempts. Exiting.

[완료]
      총 시도: 1회
      성공: 1, 실패: 0
```

### 7. 생성된 데이터

#### HDF5 파일
- `datasets/generated_dataset.hdf5` (186KB)
  - demo_0: actions, initial_state, obs, states

#### 렌더링 이미지
- `output/` 폴더에 912개 PNG 이미지
  - normals: 456개
  - segmentation: 456개

## 핵심 교훈

1. **nest_asyncio의 중요성**: Isaac Sim(Kit)과 함께 asyncio를 사용할 때 `nest_asyncio.apply()`가 필수
2. **공식 API 사용**: 커스텀 async 구현보다 Isaac Lab의 `setup_async_generation()`, `env_loop()` 사용 권장
3. **unbuffered 출력**: Isaac Sim 환경에서 print 출력을 보려면 Python `-u` 플래그 필요
4. **Docker 볼륨 마운트**: 파일 수정 후 컨테이너 재시작으로 변경사항 반영 필요

## 향후 작업
- Jupyter 노트북의 Data Generation 셀도 동일한 방식(nest_asyncio + 공식 API)으로 수정 가능
- 생성된 데이터를 Cosmos로 비주얼 증강 진행 가능

---

## 세션 2: Git 저장소 설정

### 작업 일시
2026-02-03

### 목적
- 원본 NVIDIA 저장소를 건드리지 않고 개인 저장소에서 개발 이력 관리
- 이번 세션 작업 내용 버전 관리

### 작업 내용

#### 1. Git Remote 재구성
- 기존 `origin` (NVIDIA 원본)을 `upstream`으로 변경
- 개인 저장소를 새 `origin`으로 설정

```bash
git remote rename origin upstream
git remote add origin git@github.com:scholarchoi-yjchoi/mimicgen.git
```

#### 2. SSH 키 설정
- SSH 키 생성 (`ssh-keygen -t ed25519`)
- GitHub에 공개키 등록
- SSH URL로 remote 설정

#### 3. 최종 Remote 구성

| Remote | URL | 용도 |
|--------|-----|------|
| `origin` | `git@github.com:scholarchoi-yjchoi/mimicgen.git` | 개인 저장소 (push용) |
| `upstream` | `https://github.com/NVIDIA-Omniverse-blueprints/synthetic-manipulation-motion-generation.git` | 원본 저장소 (참조용) |

#### 4. 커밋된 변경사항

**수정된 파일:**
- `docker-compose.yml` - standalone 스크립트 마운트 추가
- `launch.sh` - MODE 환경변수 및 -u 플래그 지원
- `notebook/generate_dataset.ipynb`

**새로 추가된 파일:**
- `CLAUDE.md` - Claude Code 프로젝트 컨텍스트
- `notebook/generate_data_standalone.py` - Standalone 데이터 생성 스크립트
- `work_log.txt` - 작업 로그

### 사용법

```bash
# 개인 저장소로 push
git push origin main

# 원본 저장소에서 업데이트 가져오기 (필요시)
git fetch upstream
git merge upstream/main
```

---

## 세션 3: 프로젝트 문서화 및 시각화

### 작업 일시
2026-02-03

### 목적
- 프로젝트를 다른 사람에게 쉽게 설명할 수 있는 시각화 자료 생성
- 신규 참여자를 위한 기술 문서 작성

### 작업 내용

#### 1. 3D 애니메이션 시각화 HTML 생성

**파일**: `project_visualization.html` (32KB, 1010줄)

**사용 기술:**
- Three.js: 3D 로봇 팔 및 큐브 스태킹 애니메이션
- CSS 애니메이션: 파티클, 펄스, 쉐이크 효과
- 반응형 디자인: 모바일/데스크톱 지원

**주요 섹션:**
| 섹션 | 내용 | 애니메이션 |
|------|------|-----------|
| Hero | 프로젝트 소개 | 3D 로봇 팔 + 큐브 |
| Pipeline | 데이터 생성 파이프라인 | 회전하는 Franka 로봇 |
| Problem | AsyncIO 충돌 문제 | 펄스/쉐이크 효과 |
| Solution | 해결책 4가지 | 호버 인터랙션 |
| Timeline | 개발 과정 (v6→v5) | 타임라인 시각화 |
| Results | 실행 결과 통계 | 숫자 하이라이트 |

#### 2. 기술 문서 (DOCX) 생성

**파일**: `Isaac_Lab_MimicGen_Technical_Report.docx` (43KB)

**문서 구조:**
1. 프로젝트 개요 (Project Overview)
2. 시스템 아키텍처 (System Architecture)
3. 개발 환경 설정 (Development Environment)
4. 데이터 생성 파이프라인 (Data Generation Pipeline)
5. 문제 상황 및 해결 (Problem Analysis and Solution)
6. 핵심 코드 설명 (Core Code Explanation)
7. 실행 가이드 (Execution Guide)
8. 결과 및 출력물 (Results and Outputs)
9. 향후 계획 (Future Work)
- 부록 A: 파일 구조
- 부록 B: 트러블슈팅

**문서 특징:**
- Technical Report 형식
- 신규 참여자도 이해할 수 있는 상세한 설명
- 코드 스니펫 및 아키텍처 다이어그램 포함
- 트러블슈팅 가이드 포함

#### 3. 생성된 파일 목록

| 파일 | 크기 | 용도 |
|------|------|------|
| `project_visualization.html` | 32KB | 3D 애니메이션 시각화 |
| `Isaac_Lab_MimicGen_Technical_Report.docx` | 43KB | 기술 문서 |
| `create_technical_report.py` | 17KB | DOCX 생성 스크립트 |

### 사용 방법

```bash
# HTML 시각화 열기
xdg-open project_visualization.html
# 또는 브라우저에서 직접 열기

# DOCX 문서 열기
libreoffice Isaac_Lab_MimicGen_Technical_Report.docx
```

---

## 세션 4: Standalone 모드 개선

### 작업 일시
2026-02-03

### 목적
- Standalone 모드 실행 시 출력 데이터가 로컬 PC에 저장되도록 수정
- 생성 횟수를 환경 변수로 설정 가능하게 변경
- 컨테이너 무한 재시작 문제 해결

### 문제 상황

#### 문제 1: 출력 데이터 손실
- 기존: 입력 파일만 마운트 (`samples/annotated_dataset.hdf5`)
- 출력 파일(`generated_dataset.hdf5`)과 이미지(`output/`)가 컨테이너 내부에만 저장
- 컨테이너 종료 시 생성된 데이터 손실

#### 문제 2: 컨테이너 무한 재시작
- `restart: unless-stopped` 설정으로 작업 완료 후에도 재시작

#### 문제 3: 생성 횟수 고정
- `generation_num_trials: 1` 하드코딩되어 변경 불가

### 해결 방법

#### 1. 로컬 폴더 생성 및 입력 파일 복사
```bash
mkdir -p datasets output
cp samples/annotated_dataset.hdf5 datasets/
```

#### 2. docker-compose.yml 수정

**환경 변수 추가:**
```yaml
environment:
  MODE: ${MODE:-jupyter}
  NUM_TRIALS: ${NUM_TRIALS:-1}
```

**볼륨 마운트 변경:**
```yaml
volumes:
  - ./datasets:/workspace/isaaclab/datasets    # 폴더 전체 마운트
  - ./output:/workspace/isaaclab/output        # 출력 이미지 마운트 추가
```

#### 3. generate_data_standalone.py 수정

```python
# 환경 변수에서 생성 횟수 읽기 (기본값: 1)
num_trials = int(os.environ.get("NUM_TRIALS", "1"))
print(f"[설정] 목표 생성 횟수: {num_trials}", flush=True)

config = {
    "generation_num_trials": num_trials,
    ...
}
```

#### 4. launch.sh 수정

```bash
# 필수 패키지 설치 추가
/isaac-sim/kit/python/bin/python3 -m pip install nest_asyncio toml -q
```

### 실행 방법

```bash
# 기본 실행 (1회 생성)
MODE=standalone docker compose run --rm isaac-lab

# 여러 번 생성 (예: 5회)
MODE=standalone NUM_TRIALS=5 docker compose run --rm isaac-lab
```

**핵심**: `docker compose run --rm` 사용으로 재시작 방지

### 실행 결과

```
MODE=standalone NUM_TRIALS=3 docker compose run --rm isaac-lab

[설정] 목표 생성 횟수: 3
...
have 3 successes out of 12 trials so far
Reached 3 successes/attempts. Exiting.

[완료]
      총 시도: 12회
      성공: 3, 실패: 9
```

### 생성된 출력 파일

```
datasets/
├── annotated_dataset.hdf5   (입력)
└── generated_dataset.hdf5   (출력 - 새로 생성)

output/
├── table_cam_normals/
├── table_cam_segmentation/
├── table_high_cam_normals/
└── table_high_cam_segmentation/
```

### 수정된 파일

| 파일 | 변경 내용 |
|------|----------|
| `docker-compose.yml` | MODE, NUM_TRIALS 환경 변수 + datasets, output 볼륨 마운트 |
| `launch.sh` | nest_asyncio, toml 패키지 설치 추가 |
| `notebook/generate_data_standalone.py` | NUM_TRIALS 환경 변수 지원 |

### pip 경고 메시지 설명

실행 시 다음과 같은 pip 경고가 발생할 수 있음:
```
ERROR: pip's dependency resolver does not currently take into account
all the packages that are installed.
```

이는 Isaac Sim 컨테이너 내에 두 개의 Python 환경이 있기 때문:
- `/isaac-sim/kit/python/bin/python3`: 시스템 Python (패키지 설치용)
- `./_isaac_sim/python.sh`: Isaac Sim Python (실행용)

패키지 버전 충돌처럼 보이지만, 실제 실행에는 문제없음.

---

## 세션 5: 프로젝트 시각화 및 기술 문서 업데이트

### 작업 일시
2026-02-03

### 목적
- 프로젝트 전체 여정을 설명하는 종합적인 시각화 자료 생성
- 신규 참여자를 위한 상세 기술 문서 작성

### 작업 내용

#### 1. 3D 시각화 HTML 생성 (v2)

**파일**: `project_visualization_v2.html`

**주요 섹션:**
| 섹션 | 내용 | 3D 애니메이션 |
|------|------|--------------|
| Hero | 프로젝트 소개 | 로봇 팔 + 큐브 + 파티클 |
| Overview | 6개 핵심 컴포넌트 | 카드 호버 효과 |
| Pipeline | 데이터 생성 4단계 | 회전하는 Franka 로봇 |
| Problem | AsyncIO 충돌 문제 | Jupyter vs Isaac 충돌 |
| Journey | v1→v5 개발 타임라인 | 그라데이션 진행 |
| Solution | 4가지 핵심 해결책 | 코드 블록 |
| Sessions | 4개 작업 세션 상세 | 카드 인터랙션 |
| Results | 생성 결과 통계 | 성공 큐브 타워 |

**사용 기술:**
- Three.js: 3D 로봇 팔, 큐브 스태킹, 파티클 시스템
- CSS 애니메이션: 펄스, 셰이크, 스크롤 인디케이터
- Intersection Observer: 스크롤 기반 페이드인

#### 2. 기술 문서 (DOCX) 생성 (v2)

**파일**: `Isaac_Lab_MimicGen_Technical_Report_v2.docx` (44KB)

**문서 구조:**
1. Project Overview - 소개, 핵심 컴포넌트, 목표
2. System Architecture - 전체 구조도, 데이터 흐름
3. Development Environment - 요구사항, Docker 설정
4. Data Generation Pipeline - 파이프라인 단계, HDF5 구조
5. Problem Analysis - 원인 분석, 실패 시도들 (v1-v4)
6. Solution Implementation - v5 해결책, 핵심 코드
7. Development Sessions - 세션 1-4 상세 작업 내역
8. Execution Guide - 사전 준비, 실행 명령
9. Results and Outputs - 테스트 결과, 출력 구조
10. Troubleshooting - 5가지 주요 문제 해결
- Appendix A: 파일 구조
- Appendix B: 명령어 참조

### 생성된 파일

| 파일 | 크기 | 용도 |
|------|------|------|
| `project_visualization_v2.html` | ~35KB | 종합 3D 시각화 |
| `Isaac_Lab_MimicGen_Technical_Report_v2.docx` | 44KB | 기술 문서 |
| `create_technical_report_v2.py` | ~28KB | DOCX 생성 스크립트 |

### 사용 방법

```bash
# HTML 시각화 열기
xdg-open project_visualization_v2.html

# DOCX 문서 열기
libreoffice Isaac_Lab_MimicGen_Technical_Report_v2.docx
```

---
작성: Claude Code
